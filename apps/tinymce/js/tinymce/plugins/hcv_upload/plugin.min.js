tinymce.PluginManager.add('hcv_upload', function(editor, url) {
    // Add a button that opens a window
    var hcv = 10;
    editor.addButton('hcv_upload', {
        text: '',
        icon: 'image',
        onclick: function() {
            // Open window
            editor.windowManager.open({
                width: screen.width-100,
                height: screen.height-440,
                resizable: true,
                id: 'hcv-upload',
                url: site_url + '/admin/?page_type=media-dir',
                title: 'Chèn ảnh', 
                buttons: [{
					text: 'Chọn',
					onclick: 'submit'
				},
                {
                    text: 'Hủy',
					onclick: 'close'
				}
                ],
                
                
                onsubmit: function(e) {
                    var image_url = '';
					var title = '';
                    $("#hcv-upload iframe").contents().find("#link_insert").each(function(){
                        image_url = $(this).val();
                    });
					 
					$("#hcv-upload iframe").contents().find("#title").each(function(){
                        title = $(this).val();
                    });					
                    if(image_url != '') var add = '<img src="'  + image_url + '" title="' + title + '" alt="' + title + '" />' ;
                    else var add = '';
					
					  
					
                    $("#hcv-upload iframe").contents().find(".box").each(function(){
                        var src;
                        $(this).find("img").each(function(){
                            src = $(this).attr("real_src");
                        });
                        
                        if($(this).hasClass("active"))
                        {
                            var atrribute = '';
                            var align = '';
							var wrap = '';
							var end_wrap = '';
							var style = '';
							
                            $(this).find('.title').each(function(){
                                atrribute += " title='" + $(this).val() + "'"
                            });
                            
                            $(this).find('.alt').each(function(){
                                atrribute += " alt='" + $(this).val() + "'"
                            });
                            
                            $(this).find('.align').each(function(){
                                align += $(this).val();
                            });
							
							$(this).find('.description').each(function(){
                                description = $(this).val();
                            });
                            
							if(description != '')
							{
								wrap = '<div class="wrap-hcv-caption" style="text-align:center;"><div class="hcv-caption" style="display:inline-block;padding: 5px;background:#F5F5F5">';
								end_wrap = '<p class="hcv-caption-detail" style="text-align:center;background:#F5F5F5">'+ description +'</p></div></div>';
							}
							
                            if(align=='center')
							{
								wrap += '<p style="text-align:center">';
								end_wrap += '</p>';
							}
							else
							{
								style = style + "style='float:" + align + ";'";
							}
												
							  add = add + wrap + "<img " + atrribute + style +" src='" + src + "' />" + end_wrap;
							
							 
							 
							//editor.insertContent( "<div></div>" + add + "<div></div>" );
                           
                        }
                        
                    });
                    
                     editor.insertContent( add );
                    
					$(".opacity2").remove();
                    
                },
                onclose: function(e) { 
                    $(".opacity2").remove();                    
                }
            });
        
            var opacity2 = '<div class="opacity2"></div>';
            $("body").append(opacity2);
        }
    });

    // Adds a menu item to the tools menu
    editor.addMenuItem('example', {
        text: 'Example plugin',
        context: 'tools',
        onclick: function() {
            // Open window with a specific url
            editor.windowManager.open({
                title: 'TinyMCE site',
                url: 'http://www.tinymce.com',
                width: 800,
                height: 600,
                buttons: [{
                    text: 'Đóng',
                    onclick: 'close'
                }]
            });
        }
    });
});